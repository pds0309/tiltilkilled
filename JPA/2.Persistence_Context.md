


## 영속성 컨텍스트

### 영속성 컨텍스트란?

JPA를 이해하는데 가장 중요한 용어로 `엔티티를 영구히 저장하는 환경` 이라고 할 수 있다.

- `EntityManager` 로 엔티티를 저장하거나 조회하면 매니저가 영속성 컨텍스트에 엔티티를 보관하고 관리한다.

- `영속성 컨텍스트` 는 엔티티 매니저를 생성할 때 하나 만들어지며 매니저를 통해 접근하고 관리한다.

<br>


### 엔티티 생명주기

> 다음과 같은 4가지 상태가 있다.

**비영속(new/transient)**

- 영속성 컨텍스트와 전혀 관계없음

> 엔티티 객체를 생성하고 난 직후의 순수한 객체 상태라고 생각하자. 이를테면 new Member('최번개',25); 와 같은 

<br>

**영속(managed)**

- 영속성 컨텍스트에 저장된 상태

- 생성했던 객체가 `EntityManager` 를 통해 **영속성 컨텍스트** 에 저장된 것이다.

- 결국 `영속 상태` 라 하면 `영속성 컨텍스트`  에 의해 관리되는 것을 말한다.

<br> 

**준영속(detached)**

- 영속성 컨텍스트에 저장되었다가 분리됨

- 영속성 컨텍스트에 의해 관리되던 엔티티를 분리하는 것이다.
	- `em.detach()`, `em.close()`:영속성컨텍스트 닫기, `em.clear()`: 영속성 컨텍스트 초기화

<br>

**삭제(removed)**

- 삭제됨
- 엔티티를 영속성 컨텍스트와 DB에서 삭제한다.


<br>

![jpa3](https://user-images.githubusercontent.com/76927397/163708998-e29352c1-4e0a-4931-874c-450464798aaa.JPG)






<br>


### 영속성 컨텍스트 특징

**식별자**

- 영속성 컨텍스트는 `엔티티` 를 `식별자` 로 구분한다. (`@id` 가 붙은 속성)

- 따라서 영속 상태는 식별자 값이 반드시 있어야 한다. 식별자 값이 없으면 예외 발생함

**DB 저장**

- 언제 영속성 컨텍스트의 엔티티가 DB에 저장이 되나?
	- 보통 트랜잭션 커밋할 때 : `Flush` 라고 한다.

<br>

<br>


### 영속성 컨텍스트가 엔티티를 관리하면 어떤 장점이 있나?

- 1차 캐시

- 동일성 보장

- 트랜잭션을 지원하는 쓰기 지연

- 변경 감지

- 지연 로딩

<br>

> 다음 글에서 알아보자!