



## 프록시

- `대리`


### JPA 에서의 프록시란

- 엔티티를 조회해올 때 연관관계가 있는 엔티티들이 항상 사용될까?

- 비즈니스 로직에 따라 다를 것이다.

> 회원을 조회했는데 비즈니스 요구에 따라 팀 엔티티는 필요없을 수 있다.

- 당장 사용을 하지 않는데 함께 항상 조회되어야 하는 건 비효율적일 수 있다.

- 따라서 일단 조회안했다가 필요할 때 조회하는 `지연 로딩` 이라는 개념이 있다.


이런 `지연 로딩` 을 가능하게끔 실제 엔티티 객체 대신 데이터베이스 조회를 지연할 수 있게 해주는 `가짜 객체`가 필요한데 이를 `프록시 객체`라고 한다.


> JPA 명세는 지연로딩 구현법을 Hibernate 구현체에 위임했다.


**프록시의 특징**

- 프록시 클래스는 실제 클래스를 `상속` 받아서 만들어지기 때문에 실제 클래스와 겉 모양이 같다.

- 사용하는 입장에서는 진짜 객체인지 프록시 객체인 지 구분할 필요 없다.

- 프록시 객체는 `실제 객체에 대한 참조(target)` 을 보관한다.

- 프록시 객체의 메소드를 호출하면 프록시 객체는 실제 객체의 메소드를 호출한다.


<br>

**프록시 객체 초기화**

- 실제로 사용될 때(`member.getName()` 처럼) 데이터베이스를 조회해서 실제 엔티티 객체를 생성한다.
	- 이를 프록시 객체를 초기화했다고 한다.


```java
Member member = em.getReference(Member.class, "id1"); // 실제 객체가 아닌 프록시 객체를 반환한다.

member.getName(); // 프록시 객체 메소드를 호출하려고 하니 실제 멤버객체의 메소드를 호출해야한다!
```

<br>

**프록시 객체 초기화 과정**

> 그림으로 프록시 객체 초기화 과정을 알아보자

![jpa5](https://user-images.githubusercontent.com/76927397/164125792-30688d6a-4216-4665-8075-41c4e93aba51.JPG)


1. 프록시 객체에 클라이언트가 조회를 요청함

2. 프록시 객체가 실제 엔티티 객체가 생성되어 있지 않으면 영속성 컨텍스트에 실제 엔티티 생성을 요청 => `초기화`

3.4. 영속성 컨텍스트가 DB를 조회해서 엔티티 객체 생성함

5. 프록시 객체가 생성된 엔티티 객체의 참조를 `Member target` 에 보관한다.

6. 프록시 객체가 실제 엔티티 객체의 적절한 메소드를 호출하여 결과를 반환함


<br>

**프록시 객체 특징**

- 처음 사용할 때 한번만 초기화됨

- 초기화한다고 실제 엔티티 객체로 바뀌는 것은 아니고 대리로 접근해줄 뿐임

- 원본 엔티티를 상속받기 때문에 타입 체크시 주의해서 사용해야함

- 영속성 컨텍스트에 찾는 엔티티가 이미 있으면 DB 조회할 필요가 없어서 프록시가 아닌 실제 엔티티를 반환한다.

- 프록시가 영속 상태(`managed`)여야만 초기화가 가능함
	- 그렇지 않은 상태에서 초기화 시도 시 `org.hibernate.LazyInitializationException` 을 맛본다



