


### 55. 옵셔널 반환은 신중히 하라

<br>


자바 8 이전에는 메소드가 특정 조건에서 값을 반환할 수 없을 때 `예외`를 던지거나 `null` 반환을 해야 했다.

`예외`는 실 예외 상황에서만 사용해야 바람직하며 예외 생성 시 발생하는 스택 트레이스 비용도 만만치 않다.

`null` 반환의 경우는 별도의 처리 코드를 추가해야 하며 null 이 어딘가에 저장될 수 있다고 하면 어딘가에서 처리를 하지 않았을 때 NPE를 맛볼 수 있다.

<br>


**자바 8 이후로는 `Optional<T>` 를 사용한다**

null 이 아닌 T 타입 참조를 하던가 아무것도 담지 않을 수 있다.

원소를 최대 1개 가지는 불변 컬렉션과 비슷하다.

<br>

**왜 쓰나?**

옵셔널은 null 처리나 예외 던지기 보다 유용하고 사용이 쉬우며 오류 발생 가능성을 줄여준다./

**반환값이 있을 수도 없을 수도 있음을 api 사용자에게 명확하게 알려준다.**

- 클라이언트에서는 검사예외처럼 반드시 이 옵셔널을 처리하는 코드를 작성하는 것이 강제된다.

기본값을 정하거나 원하는 예외를 던지게 처리할 수 있다.

```java
String word = words.orElse("No Words!");
String word2 = words.orElseGet("Words!");
```

> 기본 값 설정 비용이 커 고려해야 할 때 `Supplier<T>` 를 인수로 받는 `orElseGet` 을 사용하면 값이 처음 필요할 때 생성시킬 수 있다.

<br>

```java
Hello hell = someHell.orElseThrow(Exception::new);
```

> 클라이언트에서 내부 값이 없을 때 상황에 맞는 예외를 던지게 할 수 있다. 실제 예외가 아니라 예외 팩토리를 건네어 예외가 실제로 발생하지 않으면 예외 생성 비용이 들지 않는다.


<br>


**컬렉션, 스트림, 배열, 옵셔널은 옵셔널로 감싸 사용하지 말라**

예를 들어 컬렉션이라면 `Optional<List<T>>` 와 같은 형태로 사용하지 말자

빈 옵셔널을 반환하기 보다 빈 컬렉션을 반환하는 것이 좋다.


<br>

**언제 사용하면 좋을까?**

- 반환 타입 대신 Optional 을 사용해야 하는 경우는 결과가 없을 수 있으며 클라이언트가 특별히 이 상황을 처리해야만 하는 경우일 때 적절하다

<br>

**사용에 대가가 없을까?**

- 옵셔널도 엄연히 새로 할당해야 하는 객체이기 때문에 그 안의 값을 꺼내려면 메소드를 호출해야 해 한 단계를 더 거치는 셈이 된다.

> 성능적으로 중요한 상황이라면 사용을 고려하자

- 박싱된 기본 타입을 담을 때 기본 타입보다 무겁다. 이를 반환하는 일이 없도록 하자

> OptionalInt, OptionalLong, OptionalDouble 등 전용 클래스를 활용하자 

<br>

**어딘가 컬렉션의 키, 값, 원소나 배열의 원소로 사용하지 마라**

- 예를 들어 맵의 키에 넣는다고 치면 키 자체가 없는 경우와 키는 있으나 빈 옵셔널인 경우에 대해 처리해야 해 혼란만 키운다.

<br>

**인스턴스 필드에 저장해두는게 필요할 순간이 있을까?**

- 이런 경우 필수 필드를 가지는 클래스와 선택 필드가 추가된 하위클래스를 따로 만들어야 되는 코드스멜 상황임

- 기본타입 필드이고 값이 없을 수 있는 경우 처리할 수는 있다. getter 메소드를 옵셔널 반환으로 해주거나 필드 자체를 옵셔널 타입으로 선언하는 것이다.


<br>


### 요약

값을 반환하지 못할 가능성이 있고 호출 할 때 마다 반환값이 없을 가능성을 염두해야 하는 메소드라면 Optional 반환을 고려하자

성능적으로 민감한 상황이라면  원래처럼 null 또는 예외를 사용하는게 적절할 수도 있다.

옵셔널은 반환값 이외의 용도로 쓰는 경우는 매우 드물다.

  